CREATE TABLE Deepr (
id INTEGER PRIMARY KEY NOT NULL,
link TEXT NOT NULL,
name TEXT NOT NULL DEFAULT '',
createdAt TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
openedCount INTEGER NOT NULL DEFAULT 0
);

CREATE TABLE Tags (
id INTEGER PRIMARY KEY NOT NULL,
name TEXT NOT NULL UNIQUE
);

CREATE TABLE LinkTags (
linkId INTEGER NOT NULL,
tagId INTEGER NOT NULL,
PRIMARY KEY (linkId, tagId),
FOREIGN KEY (linkId) REFERENCES Deepr(id) ON DELETE CASCADE,
FOREIGN KEY (tagId) REFERENCES Tags(id) ON DELETE CASCADE
);

lastInsertRowId:
SELECT last_insert_rowid();

insertDeepr:
INSERT INTO Deepr (link, name, openedCount) VALUES (?, ?, ?);

getLinksAndTags:
SELECT
  Deepr.id AS id,
  Deepr.link,
  Deepr.name,
  Deepr.createdAt,
  Deepr.openedCount,
  GROUP_CONCAT(Tags.name, ', ') AS tagsNames,
  GROUP_CONCAT(Tags.id, ', ') AS tagsIds
FROM
  Deepr
  LEFT JOIN LinkTags ON Deepr.id = LinkTags.linkId
  LEFT JOIN Tags ON LinkTags.tagId = Tags.id
WHERE
  (Deepr.link LIKE '%' || ? || '%' OR Deepr.name LIKE '%' || ? || '%')
  AND (
    ? = '' OR Tags.id = ?
  )
GROUP BY
  Deepr.id
ORDER BY
    CASE WHEN ? = 'ASC' THEN
        CASE ?
            WHEN 'createdAt' THEN Deepr.createdAt
            WHEN 'openedCount' THEN Deepr.openedCount
            WHEN 'name' THEN Deepr.name
            WHEN 'link' THEN Deepr.link
            ELSE Deepr.createdAt
        END
    END ASC,
    CASE WHEN ? = 'DESC' THEN
        CASE ?
            WHEN 'createdAt' THEN Deepr.createdAt
            WHEN 'openedCount' THEN Deepr.openedCount
            WHEN 'name' THEN Deepr.name
            WHEN 'link' THEN Deepr.link
            ELSE Deepr.createdAt
        END
    END DESC;


listDeeprAsc:
SELECT * FROM Deepr ORDER BY createdAt ASC;

deleteDeeprById:
DELETE FROM Deepr WHERE id = ?;

incrementOpenedCount:
UPDATE Deepr SET openedCount = openedCount + 1 WHERE id = ?;

updateDeeplink:
UPDATE Deepr SET link = ? , name = ? WHERE id = ?;

countDeepr:
SELECT COUNT(*) FROM Deepr;

getDeeprByLink:
SELECT * FROM Deepr WHERE link = ?;


-- Tag operations
insertTag:
INSERT OR IGNORE INTO Tags (name) VALUES (?);

getTagByName:
SELECT * FROM Tags WHERE name = ?;

getAllTags:
SELECT * FROM Tags ORDER BY name;


-- Link-Tag relations
addTagToLink:
INSERT OR IGNORE INTO LinkTags (linkId, tagId) VALUES (?, ?);

removeTagFromLink:
DELETE FROM LinkTags WHERE linkId = ? AND tagId = ?;

deleteLinkRelations:
DELETE FROM LinkTags WHERE linkId = ?;


deleteTag:
DELETE FROM Tags WHERE id = ?;

deleteTagRelations:
DELETE FROM LinkTags WHERE tagId = ?;

updateTag:
UPDATE Tags SET name = ? WHERE id = ?;


